<UserControl x:Class="DetectiveUI.Views.Tabs.EditTabView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:DetectiveUI.Converters"
             xmlns:enum="clr-namespace:DTOs.Enum;assembly=DTOs">
    <Grid>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="2*" />
        </Grid.ColumnDefinitions>

        <Border x:Name="CreateDialog"
                Visibility="{Binding ShowCreateDialog, Converter={StaticResource BoolToVisibilityConverter}}"
                Background="White"
                BorderBrush="Gray"
                BorderThickness="1"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Padding="10"
                Width="300"
                Panel.ZIndex="1">
            <StackPanel>
                <TextBlock Text="Создание нового человека" FontWeight="Bold" Margin="0,0,0,10" />

                <TextBlock Text="ФИО:" />
                <TextBox Text="{Binding NewPersonFullName, UpdateSourceTrigger=PropertyChanged}" Margin="0,0,0,10" />

                <TextBlock Text="Дата рождения:" />
                <DatePicker
                    SelectedDate="{Binding NewPersonBirthDate, Converter={StaticResource DateOnlyToDateTimeConverter}}"
                    Margin="0,0,0,10" />

                <TextBlock Text="Пол:" />
                <ComboBox ItemsSource="{Binding SexList}"
                          SelectedItem="{Binding NewPersonSex}"
                          Margin="0,0,0,10" />

                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="Отмена"
                            Command="{Binding CancelCreateCommand}"
                            Margin="0,0,5,0"
                            Padding="10,2" />
                    <Button Content="Создать"
                            Command="{Binding CreatePersonCommand}"
                            IsEnabled="{Binding CreatePersonCommand.CanExecute}"
                            Padding="10,2" />
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Левая панель - поиск и список -->
        <Grid Grid.Column="0" Margin="5">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
            </Grid.RowDefinitions>


            <GroupBox Grid.Row="0" Header="Фильтры поиска" Margin="0,0,0,5">
                <StackPanel>
                    <TextBlock Text="Поиск по ID" />

                    <StackPanel Orientation="Horizontal">
                        <TextBox Text="{Binding RelatedPersonId, UpdateSourceTrigger=PropertyChanged}" Width="150"
                                 Margin="0,0,5,0" />
                        <Button Content="Найти" Command="{Binding SearchByIdCommand}" Padding="5,2" />
                    </StackPanel>

                    <TextBlock Text="Полное имя" />
                    <TextBox Text="{Binding Filter.FullName, UpdateSourceTrigger=PropertyChanged}" />

                    <StackPanel Orientation="Horizontal">
                        <CheckBox IsChecked="{Binding UseSexFilter}" VerticalAlignment="Center" Margin="0,0,5,0" />
                        <ComboBox ItemsSource="{Binding SexList}"
                                  SelectedItem="{Binding Filter.Sex}"
                                  IsEnabled="{Binding UseSexFilter}"
                                  Width="120" />
                    </StackPanel>

                    <Grid Margin="0,5,0,0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>
                        <DatePicker Grid.Column="0" SelectedDate="{Binding Filter.MinBirthDate}" />
                        <DatePicker Grid.Column="1" SelectedDate="{Binding Filter.MaxBirthDate}" />
                    </Grid>

                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5,0,0">
                        <Button Content="Очистить" Command="{Binding ClearFiltersCommand}" Margin="0,0,5,0" />
                        <Button Content="Поиск" Command="{Binding SearchCommand}" Margin="0,0,5,0" />
                        <Button Content="Создать нового" Command="{Binding ShowCreateDialogCommand}" />
                    </StackPanel>
                </StackPanel>
            </GroupBox>

            <!-- Результаты поиска -->
            <GroupBox Grid.Row="1" Header="Результаты поиска" Margin="0,0,0,5">
                <DataGrid ItemsSource="{Binding Persons}"
                          SelectedItem="{Binding SelectedPerson}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="ФИО" Binding="{Binding FullName}" Width="*" />
                        <DataGridTextColumn Header="Дата рождения"
                                            Binding="{Binding BirthDate, StringFormat=dd.MM.yyyy}"
                                            Width="100" />
                        <DataGridTextColumn Header="Пол"
                                            Binding="{Binding Sex, Converter={StaticResource EnumConverter}}"
                                            Width="100" />
                    </DataGrid.Columns>
                </DataGrid>
            </GroupBox>

            <!-- Сообщения об ошибках -->
            <TextBlock Grid.Row="2" Text="{Binding ErrorMessage}" Foreground="Red" TextWrapping="Wrap" />
            <TextBlock Grid.Row="2" Text="{Binding SuccessMessage}" Foreground="Green" TextWrapping="Wrap"
                       Margin="0,20,0,0" />
        </Grid>

        <!-- Правая панель - редактирование -->
        <TabControl Grid.Column="1" Margin="5"
                    Visibility="{Binding SelectedPerson, Converter={StaticResource NullVisibilityConverter}}">
            <TabItem Header="Общая информация">
                <ScrollViewer>
                    <StackPanel Margin="10">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <TextBlock Grid.Row="0" Grid.Column="0" Text="ФИО:" Margin="0,0,5,5" />
                            <TextBox Grid.Row="0" Grid.Column="1"
                                     Text="{Binding SelectedPerson.FullName, UpdateSourceTrigger=PropertyChanged}"
                                     Margin="0,0,0,5" />

                            <TextBlock Grid.Row="1" Grid.Column="0" Text="Дата рождения:" Margin="0,0,5,5" />
                            <DatePicker Grid.Row="1" Grid.Column="1"
                                        SelectedDate="{Binding SelectedPerson.BirthDate, Converter={StaticResource DateOnlyToDateTimeConverter}}"
                                        Margin="0,0,0,5" />

                            <TextBlock Grid.Row="2" Grid.Column="0" Text="Пол:" Margin="0,0,5,0" />
                            <ComboBox Grid.Row="2" Grid.Column="1"
                                      ItemsSource="{Binding SexList}"
                                      SelectedItem="{Binding SelectedPerson.Sex}"
                                      Margin="0,0,0,5" />

                            <TextBlock Grid.Row="3" Grid.Column="0" Text="ID:" Margin="0,0,5,5" />
                            <TextBox Grid.Row="3" Grid.Column="1"
                                     Text="{Binding SelectedPersonDetails.Id, Mode=OneWay}"
                                     IsReadOnly="True"
                                     Margin="0,0,0,5"
                                     BorderThickness="0" />
                        </Grid>

                        <Button Content="Сохранить изменения"
                                Command="{Binding SaveChangesCommand}"
                                HorizontalAlignment="Right"
                                Margin="0,10,0,0"
                                Padding="10,5" />

                        <Button Content="Удалить человека"
                                Command="{Binding DeletePersonCommand}"
                                IsEnabled="{Binding DeletePersonCommand.CanExecute}"
                                HorizontalAlignment="Right"
                                Margin="0,10,0,0"
                                Padding="10,5"
                                Background="LightCoral"
                                Foreground="White" />
                    </StackPanel>
                </ScrollViewer>
            </TabItem>

            <TabItem Header="Контакты">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                        <ComboBox ItemsSource="{Binding ContactTypes}"
                                  SelectedItem="{Binding SelectedContactType}"
                                  Width="120" Margin="0,0,5,0" />
                        <TextBox Text="{Binding NewContactInfo, UpdateSourceTrigger=PropertyChanged}" Width="200"
                                 Margin="0,0,5,0" />
                        <Button Content="Добавить" Command="{Binding AddContactCommand}" Padding="5,2" />
                    </StackPanel>

                    <DataGrid Grid.Row="1" ItemsSource="{Binding Contacts}" AutoGenerateColumns="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Тип"
                                                Binding="{Binding Type, Converter={StaticResource EnumConverter}}"
                                                Width="*" />
                            <DataGridTextColumn Header="Информация" Binding="{Binding Info}" Width="2*" />
                            <DataGridTemplateColumn Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Удалить"
                                                Command="{Binding DataContext.DeleteContactCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding Id}"
                                                Margin="2" Padding="5,2" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>

            <TabItem Header="Связи">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                        <TextBox Text="{Binding RelatedPersonId, UpdateSourceTrigger=PropertyChanged}" Width="150"
                                 Margin="0,0,5,0" />
                        <ComboBox ItemsSource="{Binding RelationshipTypes}"
                                  SelectedItem="{Binding SelectedRelationshipType}"
                                  Width="120" Margin="0,0,5,0" />
                        <Button Content="Добавить" Command="{Binding AddRelationshipCommand}" Padding="5,2" />
                    </StackPanel>

                    <DataGrid Grid.Row="1" ItemsSource="{Binding Relationships}" AutoGenerateColumns="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Тип"
                                                Binding="{Binding Type, Converter={StaticResource EnumConverter}}"
                                                Width="*" />
                            <DataGridTextColumn Header="ID связанного лица" Binding="{Binding Person2Id}" Width="*" />
                            <DataGridTemplateColumn Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Удалить"
                                                Command="{Binding DataContext.DeleteRelationshipCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding Person2Id}"
                                                Margin="2" Padding="5,2" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>

            <TabItem Header="Документы">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                        <TextBox Text="{Binding NewDocumentInfo, UpdateSourceTrigger=PropertyChanged}" Width="275"
                                 Margin="0,0,5,0" />
                        <Button Content="Добавить паспорт" Command="{Binding AddDocumentCommand}" Padding="5,2" />
                    </StackPanel>

                    <DataGrid Grid.Row="1" ItemsSource="{Binding Documents}" AutoGenerateColumns="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Тип"
                                                Binding="{Binding Type, Converter={StaticResource EnumConverter}}"
                                                Width="*" />
                            <DataGridTextColumn Header="Данные" Binding="{Binding Payload}" Width="2*" />
                            <DataGridTemplateColumn Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Удалить"
                                                Command="{Binding DataContext.DeleteDocumentCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding Id}"
                                                Margin="2" Padding="5,2" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>

            <TabItem Header="Имущество">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="5">
                        <TextBox Text="{Binding NewPropertyName, UpdateSourceTrigger=PropertyChanged}" Width="150"
                                 Margin="0,0,5,0" />
                        <TextBox Text="{Binding NewPropertyCost, UpdateSourceTrigger=PropertyChanged}" Width="100"
                                 Margin="0,0,5,0" />
                        <Button Content="Добавить" Command="{Binding AddPropertyCommand}" Padding="5,2" />
                    </StackPanel>

                    <DataGrid Grid.Row="1" ItemsSource="{Binding Properties}" AutoGenerateColumns="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Название" Binding="{Binding Type}" Width="*" />
                            <DataGridTextColumn Header="Стоимость" Binding="{Binding Cost, StringFormat={}{0:N0}}"
                                                Width="*" />
                            <DataGridTemplateColumn Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Удалить"
                                                Command="{Binding DataContext.DeletePropertyCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding Id}"
                                                Margin="2" Padding="5,2" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>

            <TabItem Header="Характеристики">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <!-- Форма добавления новой характеристики -->
                    <StackPanel Grid.Row="0" Margin="5">
                        <TextBlock Text="Внешность:" />
                        <TextBox Text="{Binding NewAppearance, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,0,5" AcceptsReturn="True" MinHeight="60" />

                        <TextBlock Text="Характер:" />
                        <TextBox Text="{Binding NewPersonality, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,0,5" AcceptsReturn="True" MinHeight="60" />

                        <TextBlock Text="Медицинские показания:" />
                        <TextBox Text="{Binding NewMedicalConditions, UpdateSourceTrigger=PropertyChanged}"
                                 Margin="0,0,0,5" AcceptsReturn="True" MinHeight="60" />

                        <Button Content="Добавить характеристику"
                                Command="{Binding AddCharacteristicCommand}"
                                HorizontalAlignment="Right" Padding="10,5" />
                    </StackPanel>

                    <!-- Список характеристик -->
                    <DataGrid Grid.Row="1" ItemsSource="{Binding Characteristics}" AutoGenerateColumns="False">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Автор" Binding="{Binding AuthorUsername}" Width="*" />
                            <DataGridTextColumn Header="Внешность" Binding="{Binding Appearance}" Width="2*" />
                            <DataGridTextColumn Header="Характер" Binding="{Binding Personality}" Width="2*" />
                            <DataGridTextColumn Header="Мед. показания" Binding="{Binding MedicalConditions}"
                                                Width="2*" />
                            <DataGridTemplateColumn Width="Auto">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Button Content="Удалить"
                                                Command="{Binding DataContext.DeleteCharacteristicCommand, 
                                                  RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding Id}"
                                                Margin="2" Padding="5,2" />
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </TabItem>
        </TabControl>
    </Grid>
</UserControl>